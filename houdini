#!/bin/bash

if [ $# -ge 0 ]; then

    # Get date and time (for file names)
    dt=$(date '+%Y%m%d-%H%M')

    # set wireless card to monitor mode
    echo -n "Setting wlan0 to monitor mode... "
    airmon-ng start wlan0 &> /dev/null
    echo "Done"

    # start collecting macs
    echo "Starting airodump-ng (ctrl-c to stop)... "
    sleep 3
    airodump-ng wlan0mon -w harvested/$dt -o csv

    # Disable monitor mode
    echo -n "Stopping monitor mode on wlan0... "
    airmon-ng stop wlan0mon &> /dev/null
    echo "Done"

    # strip the associated mac addresses from airodump csv file
    # it's in python because why not, please dont judge me
    echo -n "Stripping macs from log file... "
    python3 modules/stripmacs.py ../harvested/$dt-01.csv ../harvested/$dt.macs
    echo "Done"

    # clean up files generated by airodump
    echo -n "Cleaning up csv files... "
    find harvested -type f -not -name '*.macs' -delete
    echo "Done"

    # Wait for wifi to associate
    echo -n "Waiting for wireless connection... "
    	sleep 3
	while true; do
        # testing...
        LC_ALL=$(nmcli -t -f DEVICE,STATE dev | grep -q "^wlan0:connected$")
        if [ $? -eq 0 ]; then
            break
        else
            # not connected, sleeping for a second
            sleep 1
        fi
    done
    echo "Connected."

    # start testing macs
    echo "About to start testing access..."
    clear
    modules/check_macs harvested/$dt.macs $(wc -l harvested/$dt.macs)

else

    echo ""
    echo "Incorrect number of arguments!"
    echo ""
    echo "Useage:"
    echo "$0 {ap name} {ap password}"
    echo ""

fi
